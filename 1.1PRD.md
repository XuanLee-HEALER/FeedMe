FeedMe v1.1 PRD

1. 背景与目标

FeedMe 是一个 macOS 状态栏 RSS 订阅器。v1.1 目标是强化订阅源管理的效率与状态栏阅读体验：
	•	订阅源管理：右键菜单极简（只保留删除），详情面板“所见即所得”编辑并自动生效。
	•	状态栏交互：
	•	右键：按名称展示所有源 → 每个源有子菜单 → 可单独刷新该源。
	•	左键：展示最新 7 条未读，两行样式展示；左键打开，右键标已读；未读列表自动上移。
	•	“更多”菜单：升级为二级结构：先按源分组（按名称排序），悬浮源后再显示该源的条目（单行展示）。

2. 版本范围（In Scope / Out of Scope）

In Scope
	•	订阅源管理界面（列表 + 详情面板）
	•	订阅源右键菜单简化
	•	状态栏右键菜单：源列表 + 源内“刷新”
	•	状态栏左键菜单：7 条未读 + 两行展示 + 右键已读 + 更多二级分组
	•	未读/已读状态更新与 UI 实时刷新

Out of Scope（v1.1 不做）
	•	订阅源编辑弹窗（已改为详情面板直改）
	•	状态栏左键菜单中的刷新入口（明确移除）
	•	全文离线、阅读模式、全文搜索、跨设备同步等

⸻

3. 术语与数据

3.1 实体

FeedSource（订阅源）
	•	id
	•	name（可编辑显示名）
	•	feedURL（可编辑）
	•	enabled（可编辑）
	•	refreshInterval（可选，本版本若已有则可编辑）
	•	lastFetchedAt / lastError（展示用，可选）

FeedItem（条目）
	•	id（内部）
	•	sourceId
	•	title
	•	link
	•	publishedAt（或 firstSeenAt 兜底）
	•	isRead（核心）
	•	dedupeKey（去重用：guid/id > link > hash(title+date)）

3.2 排序规则（统一）
	•	源排序：按 name 进行本地化排序（locale-aware），大小写不敏感。
	•	未读排序：按 publishedAt（或 firstSeenAt）倒序。
	•	v1.1 左键展示：取排序后前 7 条未读。

⸻

4. 订阅源管理界面

4.1 页面布局
	•	左侧：订阅源列表（按名称排序）
	•	右侧：订阅源详情（始终可编辑状态，无需“编辑/保存”按钮）

4.2 订阅源列表：右键菜单
	•	对列表项右键（context menu）仅显示：
	•	删除（Delete）
	•	明确移除：
	•	编辑
	•	刷新

macOS 上实现“右键菜单”使用标准 contextual menu 流程（NSMenu/menu(for:) 等）。 

4.3 详情面板：直接编辑 + 自动生效

可编辑字段（至少）
	•	name
	•	feedURL
	•	enabled（toggle）
	•	（可选）refreshInterval

自动生效定义
	•	用户修改字段后，无需点击保存：
	•	文本字段（name/feedURL）：在以下任一触发点写入持久化并生效：
	•	输入框失焦（editing end）
	•	或回车提交
	•	或 debounce（例如 400–800ms 无输入后自动提交）
	•	toggle/stepper：变化即提交（立即生效）

生效范围
	•	修改 name：立刻影响状态栏菜单（源名称排序、显示）
	•	修改 feedURL：立刻影响后续拉取目标（并清理该源的 HTTP 缓存标识可选）
	•	修改 enabled：禁用后不参与自动刷新；状态栏右键源列表可仍显示但置灰（或直接隐藏，二选一，默认建议置灰）
	•	删除：立即从列表消失，同时状态栏菜单更新

校验与错误提示
	•	feedURL 无法解析/拉取/解析失败：
	•	详情面板显示错误状态（lastError）
	•	不阻塞用户继续编辑（允许用户修正 URL）
	•	状态栏不崩溃

⸻

5. 状态栏菜单行为

5.1 状态栏图标右键菜单（全局菜单）

入口
	•	用户右键点击状态栏图标 → 弹出右键菜单

菜单结构
	•	顶层：按名称列出所有已添加源（包括禁用源则置灰）
	•	每个源为一个菜单项，并携带子菜单：
	•	刷新此源
	•	（可选）显示 最后刷新时间（disabled item）
	•	（可选）显示 错误信息（disabled item）

行为
	•	点击“刷新此源”：只触发该源刷新流程（fetch → parse → dedupe → store → 更新未读）
	•	刷新过程中：
	•	源菜单项或“刷新此源”显示进行中状态（例如标题后附加 … 或禁用并显示 “Refreshing…”）
	•	刷新完成恢复

AppKit 限制点：一旦 NSStatusItem.menu 非 nil，会覆盖 status item 的单击 action 行为；建议在需要展示某个菜单时临时赋值并在展示后置回 nil。 

⸻

5.2 状态栏图标左键菜单（阅读菜单）

入口
	•	用户左键点击状态栏图标 → 弹出左键阅读菜单

规则：移除刷新入口
	•	左键菜单内 不再显示“刷新” 相关项。

展示内容：最新 7 条未读（两行样式）
	•	固定展示：最新 7 条未读
	•	每条用“两行”展示：
	•	第 1 行：源名称  ·  时间
	•	第 2 行：标题
	•	时间显示格式：
	•	24h：HH:mm（当天）
	•	非当天：MM-dd HH:mm（或更短，你可定）

交互
	•	左键点击条目：用默认浏览器打开 link
	•	右键点击条目：弹出条目菜单（context menu）：
	•	标为已读
	•	标为已读后：
	•	该条目从左键菜单的 7 条未读中移除
	•	若还有更多未读，自动补位（“未读内容自然上移”）

技术实现要求（与 UI 直接相关）
	•	两行展示：使用 NSMenuItem.view 搭配自定义 NSView（或 NSStackView + 两个 label），实现两行排版与截断。Apple 官方文档明确支持“Menu Items 里使用 view”。 
	•	右键已读：使用 macOS contextual menu 模式为条目提供右键动作（标准 NSMenu 弹出方式）。 

注：自定义 view 的菜单项需要你自己处理高亮/选中视觉（例如在 view 里监听 highlight 状态或用 tracking），否则体验可能与系统菜单不同；这是实现层注意事项，但不改变 PRD 要求。 

⸻

5.3 “更多”菜单：升级为二级分组（源 → 条目）

出现条件
	•	当未读总数 > 7 时，左键菜单底部显示：
	•	更多…
	•	点击/悬浮 更多… 显示二级子菜单（sub menu）

二级结构要求（关键）
	•	第一级：列出所有有未读条目的源（按名称排序）
	•	第二级：鼠标悬浮到某个源 → 展示该源的未读条目列表（单行正常展示）
	•	单行内容建议：时间 · 标题（或仅标题）
	•	点击条目：打开链接（默认浏览器）
	•	（可选）右键条目：标为已读（同上）

该结构依赖 NSMenuItem.submenu，Apple 文档定义了 submenu 行为与约束（一个 submenu 不能同时挂到多个 supermenu）。 

⸻

6. 刷新与状态更新（与 v1.1 交互绑定的部分）

6.1 刷新触发点
	•	仅从：
	•	状态栏右键菜单 → 源子菜单 → “刷新此源”
	•	（管理界面可另有按钮，但本 PRD 未要求；若已有则不冲突）
	•	左键菜单不提供刷新入口。

6.2 刷新完成后的 UI 更新
	•	刷新产生新条目：
	•	未读列表立即可见（左键菜单下次打开应反映最新数据）
	•	若左键菜单正在打开状态：允许即时重建菜单（可选，但建议做）
	•	刷新失败：
	•	不影响其他源
	•	右键菜单源子菜单可展示错误（disabled item 或 tooltip）
	•	管理界面详情面板显示 lastError

⸻

7. 验收标准（可直接测试）

7.1 订阅源管理
	1.	列表项右键只有“删除”，无“编辑/刷新”。
	2.	右侧详情默认可编辑；修改 name/feedURL/enabled 后无需保存按钮且会自动生效。
	3.	修改 name 后：状态栏右键菜单源列表按新名称排序且即时生效。
	4.	删除源后：状态栏右键菜单不再出现该源。

7.2 状态栏右键菜单
	1.	右键状态栏图标会按名称列出所有已添加源。
	2.	每个源都有子菜单，包含“刷新此源”。
	3.	触发“刷新此源”只刷新该源（可通过日志/lastFetchedAt 观测）。
	4.	刷新完成后未读数据更新。

7.3 状态栏左键菜单
	1.	左键菜单不出现刷新项。
	2.	默认展示最新 7 条未读，且每条是两行：第一行“源名+时间”，第二行“标题”。
	3.	左键点击条目会在默认浏览器打开链接。
	4.	右键条目可“标为已读”，标记后该条目从未读列表消失且其他未读自动上移补位。
	5.	当未读总数 > 7，存在“更多…”入口；其二级结构为“源列表（按名称）→ 悬浮显示该源条目（单行）”；点击条目可打开链接。

⸻

8. 实现备注（不改变需求，但会让你少踩坑）
	•	左/右键不同菜单：建议“临时赋值 statusItem.menu → performClick 弹出 → 立即置回 nil”，以避免影响单击 target-action 行为。 
	•	两行菜单项：使用 NSMenuItem.view 是标准路线；注意自定义 view 的高亮与点击命中需要你实现得像系统。 

⸻

